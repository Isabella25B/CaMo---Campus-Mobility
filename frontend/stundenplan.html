<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>CaMo – Stundenplan</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .timetable-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
        
        /* FIX 1: overflow: visible damit Tooltips aus der Karte herausragen können */
        .day-card { 
            background: white; 
            border-radius: var(--radius-lg); 
            border: 1px solid var(--color-border); 
            box-shadow: var(--shadow-soft); 
            display: flex; 
            flex-direction: column; 
            position: relative;
            overflow: visible; 
        }
        
        .day-header { background: #f8f8f8; padding: 14px 18px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
        .day-name { font-weight: 700; color: var(--color-accent); font-size: 16px; }
        .lecture-item { padding: 12px 18px; border-bottom: 1px solid #f0f0f0; }
        .lecture-time { font-weight: 600; font-size: 13px; color: var(--color-text); display: block; }
        
        .connection-box { 
            font-size: 11px; 
            background: #f4f7f6; 
            padding: 8px 12px; 
            margin: 8px 15px; 
            border-radius: 8px; 
            border-left: 4px solid var(--color-accent); 
            cursor: help; 
            position: relative; 
        }

        /* FIX 2: Standard Tooltip Styling */
        .tooltip { 
            display: none; 
            position: absolute; 
            background: white; 
            border: 1px solid #ccc; 
            padding: 10px; 
            z-index: 9999; /* Sehr hoch damit es über allem liegt */
            width: 260px; 
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            left: 0; 
        }

        /* Hinweg-Tooltip: Klappt nach unten */
        .conn-to_uni .tooltip { top: 100%; margin-top: 5px; }

        /* FIX 3: Rückfahrt-Tooltip: Klappt nach oben! */
        .conn-from_uni .tooltip { bottom: 100%; margin-bottom: 10px; }

        .connection-box:hover .tooltip { display: block; }

        .suggest-box { position: absolute; background: white; border: 1px solid var(--color-border); width: 100%; z-index: 100; max-height: 200px; overflow-y: auto; display: none; border-radius: 0 0 8px 8px; }
        .suggest-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; }
        .profile-bar { display: grid; grid-template-columns: 1fr 2fr 100px auto; gap: 12px; align-items: end; margin-bottom: 25px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; color: var(--color-muted); }
        .input-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        .btn-action { padding: 11px 18px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; height: 40px; }
        .btn-save { background: var(--color-accent); color: white; transition: opacity 0.2s; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header"><img src="../Logo.png" alt="Logo" class="sidebar-logo" /></div>
        <h2>APPS</h2>
        <a href="index.html">Start</a>
        <a href="verbindungen.html">Verbindungen</a>
        <a href="favoriten.html">Favoriten</a>
        <a href="stundenplan.html" class="active">Stundenplan</a>
        <a href="karte.html">Interaktive Karte</a>
    </div>

    <div class="content">
        <div class="page-shell">
            <div class="topbar"><div class="topbar-left"><span class="breadcrumbs">Apps /</span><span class="page-name">Stundenplan</span></div></div>
            <div class="headline-bar"><h1 class="headline-title">Dein Vorlesungsplan</h1></div>

            <div class="card profile-bar">
                <div class="input-group"><label>Dein Kurs:</label><input type="text" id="courseInput" placeholder="z.B. STG-TINF25B"></div>
                <div class="input-group" style="position:relative;"><label>Heimhaltestelle:</label>
                    <input type="text" id="homeStopInput" placeholder="Suchen..." autocomplete="off">
                    <input type="hidden" id="homeStopId"><div id="suggestBox" class="suggest-box"></div>
                </div>
                <div class="input-group"><label>Puffer (Min):</label><input type="number" id="bufferInput" value="0" min="0" style="width: 70px;"></div>
                <button onclick="saveProfile()" class="btn-action btn-save">Profil speichern</button>
            </div>

            <div id="timetable" class="timetable-grid"></div>
        </div>
    </div>

    <script src="auth-check.js"></script>
    <script>
        let allStops = [];
        let homeId = "";

        document.addEventListener('DOMContentLoaded', async () => {
            if (await checkAuth()) {
                await loadStops();
                await loadProfile();
                initAutocomplete();
            }
        });

        async function loadStops() {
            try {
                const res = await fetch('http://localhost:5000/api/stops');
                allStops = await res.json();
            } catch(e) { console.error("Stops load failed"); }
        }

        async function loadProfile() {
            const token = sessionStorage.getItem('camo_token');
            try {
                const res = await fetch(`http://localhost:5000/api/user/profile?token=${token}`);
                const d = await res.json();
                if (d.username) {
                    document.getElementById('courseInput').value = d.timetable_link || "";
                    document.getElementById('homeStopInput').value = d.home_stop_name || "";
                    document.getElementById('homeStopId').value = d.home_stop_id || "";
                    document.getElementById('bufferInput').value = d.buffer_time || 0;
                    homeId = d.home_stop_id;
                    if(d.timetable_link) fetchTimetable(d.timetable_link);
                }
            } catch(e) { console.error("Profile load failed"); }
        }

        function initAutocomplete() {
            const inp = document.getElementById('homeStopInput'), box = document.getElementById('suggestBox'), idField = document.getElementById('homeStopId');
            inp.addEventListener('input', () => {
                const val = inp.value.toLowerCase().trim();
                box.innerHTML = ""; box.style.display = "none";
                if (val.length < 2) return;
                const matches = allStops.filter(s => s.name.toLowerCase().includes(val)).slice(0, 10);
                matches.forEach(m => {
                    const div = document.createElement('div'); div.className = 'suggest-item'; div.textContent = m.name;
                    div.onclick = () => { inp.value = m.name; idField.value = m.id; homeId = m.id; box.style.display = "none"; };
                    box.appendChild(div);
                });
                if(matches.length > 0) box.style.display = "block";
            });
        }

        async function saveProfile() {
            const token = sessionStorage.getItem('camo_token');
            const data = {
                course: document.getElementById('courseInput').value.toUpperCase(),
                stop_id: document.getElementById('homeStopId').value,
                stop_name: document.getElementById('homeStopInput').value,
                buffer: parseInt(document.getElementById('bufferInput').value) || 0
            };
            try {
                await fetch('http://localhost:5000/api/user/profile', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify(data)
                });
                alert("Profil gespeichert!");
                fetchTimetable(data.course);
            } catch(e) { alert("Fehler beim Speichern"); }
        }

        async function fetchTimetable(course) {
            const container = document.getElementById('timetable');
            container.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>⌛ Lade Plan...</p>";
            try {
                const res = await fetch(`http://localhost:5000/api/timetable?course=${course}`);
                const data = await res.json();
                renderTimetable(data);
                setTimeout(() => autoLoadNextJourneys(), 300);
            } catch(e) {
                container.innerHTML = "<p style='grid-column:1/-1; text-align:center; color:red;'>Fehler beim Laden des Stundenplans.</p>";
            }
        }

        function renderTimetable(events) {
            const container = document.getElementById('timetable');
            container.innerHTML = "";
            const groups = {};
            events.forEach(e => {
                const dateObj = new Date(e.startTime);
                const d = dateObj.toLocaleDateString('de-DE', {weekday:'long', day:'2-digit', month:'2-digit', year:'numeric'});
                if(!groups[d]) groups[d] = [];
                groups[d].push(e);
            });

            Object.keys(groups).forEach(dateStr => {
                const dayEvents = groups[dateStr].sort((a,b) => new Date(a.startTime) - new Date(b.startTime));
                const dateParts = dateStr.split(', ');
                const rawDate = dayEvents[0].startTime.split('T')[0];
                let html = `<div class="day-card" data-date-raw="${rawDate}" data-date-vvs="${dateParts[1].split('.').reverse().join('')}">
                    <div class="day-header"><span class="day-name">${dateParts[0]}</span><span class="day-date">${dateParts[1]}</span></div>
                    <div class="lecture-list">`;
                dayEvents.forEach(ev => {
                    const start = new Date(ev.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    const end = new Date(ev.endTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    html += `<div class="lecture-item"><span class="lecture-time" data-start="${start}" data-end="${end}">${start} – ${end}</span><span class="lecture-name">${ev.name}</span></div>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            });
        }

        function autoLoadNextJourneys() {
            if(!homeId) return;
            const now = new Date(); now.setHours(0,0,0,0);
            const futureCards = Array.from(document.querySelectorAll('.day-card')).filter(card => {
                const cardDate = new Date(card.dataset.dateRaw);
                cardDate.setHours(0,0,0,0);
                return cardDate >= now;
            });
            futureCards.slice(0, 3).forEach(card => loadSingleCard(card));
        }

        async function loadSingleCard(card) {
            const date = card.dataset.dateVvs, times = card.querySelectorAll('.lecture-time');
            if(!date || times.length === 0 || card.querySelector('.connection-box')) return;

            const userBuffer = parseInt(document.getElementById('bufferInput').value) || 0;
            const firstStart = times[0].dataset.start.replace(':','');
            const lastEnd = times[times.length-1].dataset.end.replace(':','');
            
            fetchConn(card, 'to_uni', date, firstStart, userBuffer + 10, 'afterbegin');
            fetchConn(card, 'from_uni', date, lastEnd, 10, 'beforeend');
        }

        async function fetchConn(card, mode, date, time, buffer, pos) {
            try {
                const res = await fetch(`http://localhost:5000/api/connections?mode=${mode}&userStopId=${homeId}&date=${date}&time=${time}&buffer=${buffer}`);
                const data = await res.json();
                if(data.journeys && data.journeys.length > 0) {
                    const j = data.journeys[0];
                    const label = mode === 'to_uni' ? '➡️ Hin' : '⬅️ Rück';
                    const html = `<div class="connection-box conn-${mode}">
                        <strong>${label}:</strong> ${j.dep} → ${j.arr} (${j.duration}m)
                        <div class="tooltip">${j.sections.map(s=>`<b>${s.line}</b>: ${s.from}→${s.to}`).join('<br>')}</div>
                    </div>`;
                    card.querySelector('.lecture-list').insertAdjacentHTML(pos, html);
                }
            } catch(e) { console.warn("Fetch failed"); }
        }
    </script>
</body>
</html>