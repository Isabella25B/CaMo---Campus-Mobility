<!DOCTYPE html>
<!--
  Frontend: html/stundenplan.html
  Purpose: Seite zur Anzeige des persönlichen Vorlesungsplans und automatischer
  Berechnung von An-/Abreisevorschlägen für die nächsten Termine.
-->
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CaMo – Stundenplan</title>

    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="stylesheet" href="/css/stundenplan.css" />
  </head>

  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <img src="/Logo.png" alt="Logo" class="sidebar-logo" />
      </div>
      <h2>APPS</h2>
      <a href="/">Start</a>
      <a href="/verbindungen">Verbindungen</a>
      <a href="/favoriten">Favoriten</a>
      <a href="/stundenplan" class="active">Stundenplan</a>
      <a href="/karte">Interaktive Karte</a>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="content">
      <div class="page-shell">
        <div class="topbar">
          <button
            class="mobile-menu-btn"
            id="mobileMenuBtn"
            aria-label="Menü öffnen"
          >
            ☰
          </button>
          <div class="topbar-left">
            <span class="breadcrumbs">Apps /</span>
            <span class="page-name">Stundenplan</span>
          </div>
        </div>

        <div class="headline-bar">
          <h1 class="headline-title">Dein Vorlesungsplan</h1>
        </div>

        <div class="page-content page-content--single">
          <div class="card profile-bar">
            <div class="input-group">
              <label>Dein Kurs:</label>
              <input
                type="text"
                id="courseInput"
                placeholder="z.B. STG-TINF25B"
              />
            </div>

            <div class="input-group input-group--relative">
              <label>Heimhaltestelle:</label>
              <input
                type="text"
                id="homeStopInput"
                placeholder="Suchen..."
                autocomplete="off"
              />
              <input type="hidden" id="homeStopId" />
              <div id="suggestBox" class="suggest-box"></div>
            </div>

            <div class="input-group">
              <label>Puffer (Min):</label>
              <input
                type="number"
                id="bufferInput"
                class="buffer-input"
                value="0"
                min="0"
              />
            </div>

            <button onclick="saveProfile()" class="btn-action btn-save">
              Profil speichern
            </button>
          </div>

          <div id="timetable" class="timetable-grid">
            <div class="loading-state loading-full">Prüfe Anmeldung...</div>
          </div>
        </div>
      </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/auth-check.js"></script>

    <script>
      /**
       * Script für die Stundenplan-Seite: lädt Stops/Profile, rendert Stundenplan
       * und lädt zugehörige Verbindungen für kommende Unterrichtstage.
       */
      let allStops = [];
      let homeId = "";

      // Initialisierung: Auth prüfen -> Stops & Profile laden -> Autocomplete
      document.addEventListener("DOMContentLoaded", async () => {
        // Erst Auth prüfen, DANN den Rest laden
        const isAuthenticated = await checkAuth();
        if (isAuthenticated) {
          await loadStops();
          await loadProfile();
          initAutocomplete();
        }
      });

      /**
       * Lädt die Liste aller Haltestellen vom Backend in `allStops`.
       */
      async function loadStops() {
        try {
          const res = await fetch(`${API_BASE}/api/stops`);
          allStops = await res.json();
        } catch (e) {
          console.error("Stops load failed");
        }
      }

      /**
       * Lädt das Benutzerprofil (inkl. Home-Stop, Buffer, Timetable-Link) und
       * füllt die Eingabefelder. Ruft bei vorhandenem Link `fetchTimetable()` auf.
       */
      async function loadProfile() {
        const token = sessionStorage.getItem("camo_token");
        try {
          const res = await fetch(
            `${API_BASE}/api/user/profile?token=${token}`
          );
          const d = await res.json();

          if (d.username) {
            document.getElementById("courseInput").value =
              d.timetable_link || "";
            document.getElementById("homeStopInput").value =
              d.home_stop_name || "";
            document.getElementById("homeStopId").value = d.home_stop_id || "";
            document.getElementById("bufferInput").value = d.buffer_time || 0;

            homeId = d.home_stop_id;

            if (d.timetable_link) fetchTimetable(d.timetable_link);
          }
        } catch (e) {
          console.error("Profile load failed");
        }
      }

      /**
       * Initialisiert das Autocomplete für das Home-Stop Eingabefeld anhand von `allStops`.
       */
      function initAutocomplete() {
        const inp = document.getElementById("homeStopInput");
        const box = document.getElementById("suggestBox");
        const idField = document.getElementById("homeStopId");
        if (!inp) return;

        inp.addEventListener("input", () => {
          const val = inp.value.toLowerCase().trim();
          box.innerHTML = "";
          box.style.display = "none";
          if (val.length < 2) return;

          const matches = allStops
            .filter((s) => s.name.toLowerCase().includes(val))
            .slice(0, 10);

          matches.forEach((m) => {
            const div = document.createElement("div");
            div.className = "suggest-item";
            div.textContent = m.name;
            div.onclick = () => {
              inp.value = m.name;
              idField.value = m.id;
              homeId = m.id;
              box.style.display = "none";
            };
            box.appendChild(div);
          });

          if (matches.length > 0) box.style.display = "block";
        });
      }

      /**
       * Speichert das Profil des Benutzers via API und lädt anschließend den Stundenplan neu.
       */
      async function saveProfile() {
        const token = sessionStorage.getItem("camo_token");
        const data = {
          course: document.getElementById("courseInput").value.toUpperCase(),
          stop_id: document.getElementById("homeStopId").value,
          stop_name: document.getElementById("homeStopInput").value,
          buffer: parseInt(document.getElementById("bufferInput").value) || 0,
        };

        try {
          await fetch(`${API_BASE}/api/user/profile`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify(data),
          });
          alert("Profil gespeichert!");
          fetchTimetable(data.course);
        } catch (e) {
          alert("Fehler beim Speichern");
        }
      }

      /**
       * Holt den Stundenplan für `course` vom Backend und löst das Rendern aus.
       */
      async function fetchTimetable(course) {
        const container = document.getElementById("timetable");
        if (!container) return;

        container.innerHTML = "<p class='timetable-status'>⌛ Lade Plan...</p>";

        try {
          const res = await fetch(`${API_BASE}/api/timetable?course=${course}`);
          const data = await res.json();
          renderTimetable(data);
          setTimeout(() => autoLoadNextJourneys(), 300);
        } catch (e) {
          container.innerHTML =
            "<p class='timetable-status timetable-status--error'>Fehler beim Laden des Stundenplans.</p>";
        }
      }

      /**
       * Rendert die übergebenen Events in Tages-Gruppen im DOM.
       * @param {Array} events Array von Event-Objekten mit startTime/endTime/name
       */
      function renderTimetable(events) {
        const container = document.getElementById("timetable");
        container.innerHTML = "";
        const groups = {};

        events.forEach((e) => {
          const dateObj = new Date(e.startTime);
          const d = dateObj.toLocaleDateString("de-DE", {
            weekday: "long",
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
          });
          if (!groups[d]) groups[d] = [];
          groups[d].push(e);
        });

        Object.keys(groups).forEach((dateStr) => {
          const dayEvents = groups[dateStr].sort(
            (a, b) => new Date(a.startTime) - new Date(b.startTime)
          );

          const dateParts = dateStr.split(", ");
          const rawDate = dayEvents[0].startTime.split("T")[0];

          let html = `
            <div class="day-card"
                 data-date-raw="${rawDate}"
                 data-date-vvs="${dateParts[1].split(".").reverse().join("")}">
              <div class="day-header">
                <span class="day-name">${dateParts[0]}</span>
                <span class="day-date">${dateParts[1]}</span>
              </div>
              <div class="lecture-list">
          `;

          dayEvents.forEach((ev) => {
            const start = new Date(ev.startTime).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });
            const end = new Date(ev.endTime).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });

            html += `
              <div class="lecture-item">
                <span class="lecture-time" data-start="${start}" data-end="${end}">
                  ${start} – ${end}
                </span>
                <span class="lecture-name">${ev.name}</span>
              </div>
            `;
          });

          html += `
              </div>
            </div>
          `;

          container.innerHTML += html;
        });
      }

      /**
       * Lädt zu den nächsten Tagen automatisch passende Verbindungen (bis 3 Karten)
       * und ruft `loadSingleCard` für jede Karte auf.
       */
      function autoLoadNextJourneys() {
        if (!homeId) return;

        const now = new Date();
        now.setHours(0, 0, 0, 0);

        const futureCards = Array.from(
          document.querySelectorAll(".day-card")
        ).filter((card) => {
          const cardDate = new Date(card.dataset.dateRaw);
          cardDate.setHours(0, 0, 0, 0);
          return cardDate >= now;
        });

        futureCards.slice(0, 3).forEach((card) => loadSingleCard(card));
      }

      /**
       * Lädt für eine einzelne Tageskarte passende An-/Abreisevorschläge und
       * fügt sie in die Karte ein.
       */
      async function loadSingleCard(card) {
        const date = card.dataset.dateVvs;
        const times = card.querySelectorAll(".lecture-time");

        if (
          !date ||
          times.length === 0 ||
          card.querySelector(".connection-box")
        )
          return;

        const userBuffer =
          parseInt(document.getElementById("bufferInput").value) || 0;
        const firstStart = times[0].dataset.start.replace(":", "");
        const lastEnd = times[times.length - 1].dataset.end.replace(":", "");

        fetchConn(
          card,
          "to_uni",
          date,
          firstStart,
          userBuffer + 10,
          "afterbegin"
        );
        fetchConn(card, "from_uni", date, lastEnd, 10, "beforeend");
      }

      /**
       * Führt einen Connection-Request an das Backend aus und fügt das Ergebnis
       * als kleine Connection-Box in die Karte ein.
       */
      async function fetchConn(card, mode, date, time, buffer, pos) {
        try {
          const res = await fetch(
            `${API_BASE}/api/connections?mode=${mode}&userStopId=${homeId}&date=${date}&time=${time}&buffer=${buffer}`
          );
          const data = await res.json();

          if (data.journeys && data.journeys.length > 0) {
            const j = data.journeys[0];
            const label = mode === "to_uni" ? "➡️ Hin" : "⬅️ Rück";

            const html = `
              <div class="connection-box conn-${mode}">
                <strong>${label}:</strong> ${j.dep} → ${j.arr} (${j.duration}m)
                <div class="tooltip">
                  ${j.sections
                    .map((s) => `<b>${s.line}</b>: ${s.from}→${s.to}`)
                    .join("<br>")}
                </div>
              </div>
            `;

            card.querySelector(".lecture-list").insertAdjacentHTML(pos, html);
          }
        } catch (e) {
          console.warn("Fetch failed");
        }
      }
    </script>
    <script>
      const menuBtn = document.getElementById("mobileMenuBtn");
      const sidebar = document.querySelector(".sidebar");
      const overlay = document.getElementById("sidebarOverlay");

      if (menuBtn) {
        menuBtn.addEventListener("click", () => {
          sidebar.classList.add("open");
          overlay.classList.add("show");
        });
      }

      if (overlay) {
        overlay.addEventListener("click", () => {
          sidebar.classList.remove("open");
          overlay.classList.remove("show");
        });
      }
    </script>
  </body>
</html>
