<!DOCTYPE html>
<!--
  Frontend: html/favoriten.html
  Purpose: Zeigt die gespeicherten Favoriten des eingeloggten Benutzers an
  und erlaubt das L√∂schen von Favoriten.
-->
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CaMo ‚Äì Favoriten</title>

    <!-- Globales Styling -->
    <link rel="stylesheet" href="/css/styles.css" />

    <!-- Seiten-spezifisches Styling -->
    <link rel="stylesheet" href="/css/favoriten.css" />
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <img src="/Logo.png" alt="CaMo Logo" class="sidebar-logo" />
      </div>
      <h2>APPS</h2>
      <a href="/">Start</a>
      <a href="/verbindungen">Verbindungen</a>
      <a href="/favoriten" class="active">Favoriten</a>
      <a href="/stundenplan">Stundenplan</a>
      <a href="/karte">Interaktive Karte</a>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="content">
      <div class="page-shell">
        <div class="topbar">
          <button
            class="mobile-menu-btn"
            id="mobileMenuBtn"
            aria-label="Men√º √∂ffnen"
          >
            ‚ò∞
          </button>

          <div class="topbar-left">
            <span class="breadcrumbs">Apps /</span>
            <span class="page-name">Favoriten</span>
          </div>
        </div>

        <div class="headline-bar">
          <h1 class="headline-title">Deine gespeicherten Favoriten</h1>
        </div>

        <div class="page-content page-content--single">
          <div id="favoritesList" class="favorites-container">
            <div class="loading-state">Pr√ºfe Anmeldung...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/js/auth-check.js"></script>
    <script src="/js/config.js"></script>

    <script>
      // Init: pr√ºft Auth und l√§dt Favoriten
      document.addEventListener("DOMContentLoaded", async () => {
        if (await checkAuth()) {
          loadFavorites();
        }
      });

      /**
       * L√§dt die Favoriten des Benutzers vom Backend und rendert sie in #favoritesList.
       */
      async function loadFavorites() {
        const token = sessionStorage.getItem("camo_token");
        const res = await fetch(
          `${API_BASE}/api/favorites/connection?token=${token}`
        );
        const favs = await res.json();
        const container = document.getElementById("favoritesList");

        container.innerHTML = "";

        if (favs.length === 0) {
          container.innerHTML = `<div class="card no-favorites">Keine Favoriten.</div>`;
          return;
        }

        favs.forEach((f) => {
          const sections =
            typeof f.sections_json === "string"
              ? JSON.parse(f.sections_json)
              : f.sections_json;

          container.innerHTML += `
          <div class="card fav-entry">
            <div class="journey-header">
              <span>${f.dep_time} ‚Äì ${f.arr_time} (${f.duration} Min.)</span>
              <button class="fav-remove" onclick="deleteFavorite(${
                f.id
              })">üóëÔ∏è</button>
            </div>
            <hr />
            ${sections
              .map(
                (s) => `
                  <div class="leg">
                    <strong>${s.line}</strong>: ${s.from} (${s.departure})<br />
                    <span class="arrow">‚Ü≥ an ${s.to} (${s.arrival})</span>
                  </div>
                `
              )
              .join("")}
          </div>
        `;
        });
      }

      /**
       * L√∂scht ein Favorit √ºber das Backend und l√§dt die Liste neu.
       * @param {number} id Favoriten-ID
       */
      async function deleteFavorite(id) {
        if (!confirm("L√∂schen?")) return;

        const token = sessionStorage.getItem("camo_token");

        await fetch(`${API_BASE}/api/favorites/connection/${id}`, {
          method: "DELETE",
          headers: {
            Authorization: token,
          },
        });

        loadFavorites();
      }
    </script>

    <script>
      const menuBtn = document.getElementById("mobileMenuBtn");
      const sidebar = document.querySelector(".sidebar");
      const overlay = document.getElementById("sidebarOverlay");

      if (menuBtn) {
        menuBtn.addEventListener("click", () => {
          sidebar.classList.add("open");
          overlay.classList.add("show");
        });
      }

      if (overlay) {
        overlay.addEventListener("click", () => {
          sidebar.classList.remove("open");
          overlay.classList.remove("show");
        });
      }
    </script>
  </body>
</html>
